name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install
        
      - name: Run ESLint
        run: bun run lint
        
      - name: Check formatting with Prettier
        run: bun run format:check

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        bun-version: [latest]
        
    steps:
      - uses: actions/checkout@v3
      
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ matrix.bun-version }}
          
      - name: Install dependencies
        run: bun install
        
      - name: Run tests
        run: bun test
        
      - name: Run test coverage
        run: bun test --coverage

  build:
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install
        
      - name: Check syntax
        run: bun run check
        
      - name: Test example servers
        run: |
          cd examples/minimal-server
          bun install
          timeout 10s bun run dev || code=$?; if [[ $code -ne 124 && $code -ne 0 ]]; then exit $code; fi
          
          cd ../basic-server
          bun install
          timeout 10s bun run dev || code=$?; if [[ $code -ne 124 && $code -ne 0 ]]; then exit $code; fi
          
          cd ../us-core-server
          bun install
          timeout 10s bun run dev || code=$?; if [[ $code -ne 124 && $code -ne 0 ]]; then exit $code; fi

  validate-fhir:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install
        
      - name: Validate FHIR resources
        run: |
          # Run FHIR validation tests
          bun test test/validation.test.js
          
      - name: Check CapabilityStatement generation
        run: |
          # Test that capability statement generates correctly
          bun run test/capability-statement.test.js || true